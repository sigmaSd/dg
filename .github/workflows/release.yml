name: Release

on:
  push:
    tags:
      - 'v*'
    branches:
      - feat/cross-platform-bundle

permissions:
  contents: write

jobs:
  build:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        include:
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            output: dg-linux
          - os: macos-latest
            target: x86_64-apple-darwin
            output: dg-macos-x86_64
          - os: macos-latest
            target: aarch64-apple-darwin
            output: dg-macos-aarch64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            output: dg-windows.exe

    steps:
      - name: Setup repo
        uses: actions/checkout@v4

      - name: Setup Deno
        uses: denoland/setup-deno@v2

      - name: Setup MSYS2 (Windows)
        if: runner.os == 'Windows'
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          update: true
          cache: true
          install: >-
            mingw-w64-x86_64-gtk4
            mingw-w64-x86_64-libadwaita
            mingw-w64-x86_64-adwaita-icon-theme
            mingw-w64-x86_64-7zip

      - name: Build binary
        run: |
          deno compile --allow-all --unstable-worker-options --output ${{ matrix.output }} --target ${{ matrix.target }} src/main.ts

      - name: Package Windows (Portable ZIP and Installer)
        if: runner.os == 'Windows'
        shell: msys2 {0}
        run: |
          mkdir -p dist-windows
          cp dg-windows.exe dist-windows/dg.exe
          cp /mingw64/bin/*.dll dist-windows/
          mkdir -p dist-windows/share
          cp -r /mingw64/share/icons dist-windows/share/
          cp -r /mingw64/share/glib-2.0 dist-windows/share/
          
          # Compile schemas just in case
          glib-compile-schemas /mingw64/share/glib-2.0/schemas/
          cp /mingw64/share/glib-2.0/schemas/gschemas.compiled dist-windows/share/glib-2.0/schemas/
          
          # Create ZIP bundle
          7z a dg-windows.zip ./dist-windows/*
          
          # Create Inno Setup script
          cat <<EOF > installer.iss
          [Setup]
          AppName=dg
          AppVersion=${{ github.ref_name }}
          DefaultDirName={autopf}\dg
          DefaultGroupName=dg
          OutputDir=.
          OutputBaseFilename=dg-setup
          Compression=lzma
          SolidCompression=yes
          ArchitecturesInstallIn64BitMode=x64

          [Files]
          Source: "dist-windows\dg.exe"; DestDir: "{app}"; Flags: ignoreversion
          Source: "dist-windows\*.dll"; DestDir: "{app}"; Flags: ignoreversion
          Source: "dist-windows\share\*"; DestDir: "{app}\share"; Flags: ignoreversion recursesubdirs

          [Icons]
          Name: "{group}\dg"; Filename: "{app}\dg.exe"
          Name: "{autodesktop}\dg"; Filename: "{app}\dg.exe"
          EOF

          # Run Inno Setup compiler
          "/c/Program Files (x86)/Inno Setup 6/ISCC.exe" installer.iss || iscc installer.iss || echo "ISCC not found"

      - name: Upload binary
        if: startsWith(github.ref, 'refs/tags/v')
        uses: softprops/action-gh-release@v1
        with:
          files: |
            dg-setup.exe
            dg-windows.zip
            dg-linux
            dg-macos-x86_64
            dg-macos-aarch64
          fail_on_unmatched_files: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
